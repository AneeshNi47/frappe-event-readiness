[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Event Readiness",
  "enabled": 1,
  "modified": "2025-12-03 17:50:40.001457",
  "module": null,
  "name": "Event UI Customization",
  "script": "//-------------------------------------------------------------\n// Load ApexCharts if not already loaded\n//-------------------------------------------------------------\nfunction load_apexcharts(callback) {\n    if (typeof ApexCharts !== \"undefined\") {\n        callback();\n        return;\n    }\n    const script = document.createElement(\"script\");\n    script.src = \"https://cdn.jsdelivr.net/npm/apexcharts@3.45.0\";\n    script.onload = callback;\n    document.head.appendChild(script);\n}\n\n//-------------------------------------------------------------\n// EVENT READINESS CLIENT SCRIPT\n//-------------------------------------------------------------\nfrappe.ui.form.on('Event Readiness', {\n    refresh(frm) {\n        if (frm.is_new()) {\n            frm.fields_dict.custom_event_readiness_gauge.$wrapper.empty();\n            frm.fields_dict.custom_tasks_overview.$wrapper.empty();\n            return;\n        }\n\n        load_apexcharts(() => frm.trigger(\"render_gauge\"));\n        frm.trigger(\"render_tasks\");\n    },\n\n    //---------------------------------------------------------\n    // GAUGE + SUMMARY PANEL\n    //---------------------------------------------------------\n    render_gauge(frm) {\n        if (!frm.fields_dict.custom_event_readiness_gauge) return;\n\n        const readiness = frm.doc.event_readiness || 0;\n\n        let gauge_color = '#dc3545';\n        if (readiness >= 70) gauge_color = '#28a745';\n        else if (readiness >= 40) gauge_color = '#ffc107';\n\n        const total     = frm.doc.total_tasks || 0;\n        const pending   = frm.doc.pending_tasks || 0;\n        const progress  = frm.doc.in_progress_tasks || 0;\n        const completed = frm.doc.completed_tasks || 0;\n        const delayed   = frm.doc.delayed_tasks || 0;\n\n        frm.fields_dict.custom_event_readiness_gauge.$wrapper.html(`\n            <div style=\"display:flex; gap:40px; justify-content:center; margin-top:10px;\">\n\n                <!-- GAUGE LEFT -->\n                <div style=\"flex:1; text-align:center;\">\n                    <h4 style=\"margin-bottom:10px;\">Event Readiness: ${readiness}%</h4>\n                    <div id=\"event_readiness_gauge\" style=\"height:260px;\"></div>\n                </div>\n\n                <!-- SUMMARY RIGHT -->\n                <div style=\"flex:1;\">\n                    <h4>Task Summary</h4>\n                    <div style=\"display:grid; grid-template-columns:repeat(2,1fr); gap:10px;\">\n                        <div class=\"stat-card\"><b>Total Tasks</b><br>${total}</div>\n                        <div class=\"stat-card\" style=\"color:#0dcaf0;\"><b>Pending</b><br>${pending}</div>\n                        <div class=\"stat-card\" style=\"color:#ffc107;\"><b>In Progress</b><br>${progress}</div>\n                        <div class=\"stat-card\" style=\"color:#28a745;\"><b>Completed</b><br>${completed}</div>\n                        <div class=\"stat-card\" style=\"color:#dc3545;\"><b>Delayed</b><br>${delayed}</div>\n                    </div>\n                </div>\n            </div>\n        `);\n\n        new ApexCharts(document.querySelector(\"#event_readiness_gauge\"), {\n            series: [readiness],\n            chart: { type: 'radialBar', height: 260 },\n            colors: [gauge_color],\n            labels: ['Readiness'],\n            plotOptions: {\n                radialBar: {\n                    hollow: { size: \"60%\" },\n                    dataLabels: { value: { formatter: () => readiness + \"%\" } }\n                }\n            }\n        }).render();\n    },\n\n    //---------------------------------------------------------\n    // TASK TABLE + FILTERS + SORTING + STATUS DROPDOWN\n    //---------------------------------------------------------\n    render_tasks(frm) {\n        frappe.call({\n            method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.get_tasks_for_event\",\n            args: { event_name: frm.doc.name },\n            callback(r) {\n                const data = r.message || {};\n                let tasks = data.tasks || [];\n                const current_user = data.user;\n                const user_sector = data.user_sector;\n                const is_lead = data.is_lead === 1;\n\n                let filter_status = \"\";\n                let filter_sector = \"\";\n                let filter_incharge = \"\";\n                let sort_field = \"creation\";\n                let sort_order = \"asc\";\n\n                function applyFiltersAndRender() {\n                    let filtered = tasks;\n\n                    if (filter_sector)  filtered = filtered.filter(t => t.sector === filter_sector);\n                    if (filter_status)  filtered = filtered.filter(t => t.status === filter_status);\n                    if (filter_incharge) filtered = filtered.filter(t => t.incharge === filter_incharge);\n\n                    filtered.sort((a, b) =>\n                        (a[sort_field] < b[sort_field] ? -1 : 1) * (sort_order === \"asc\" ? 1 : -1)\n                    );\n\n                    renderTable(filtered);\n                }\n\n                window.sortBy = function(field) {\n                    sort_field = field;\n                    sort_order = sort_order === \"asc\" ? \"desc\" : \"asc\";\n                    applyFiltersAndRender();\n                };\n\n                function renderTable(taskList) {\n                    let html = `\n                        <div style=\"display:flex; justify-content:space-between; margin-bottom:12px;\">\n                            <div style=\"display:flex; gap:10px;\">\n                                <select id=\"flt-status\" class=\"form-control\" style=\"width:140px\">\n                                    <option value=\"\">All Status</option>\n                                    <option>Pending</option>\n                                    <option>In Progress</option>\n                                    <option>Completed</option>\n                                    <option>Delayed</option>\n                                </select>\n\n                                <select id=\"flt-sector\" class=\"form-control\" style=\"width:140px\">\n                                    <option value=\"\">All Sectors</option>\n                                    ${[...new Set(tasks.map(t => t.sector))].map(sec => `<option>${sec}</option>`).join(\"\")}\n                                </select>\n\n                                <select id=\"flt-incharge\" class=\"form-control\" style=\"width:140px\">\n                                    <option value=\"\">All Users</option>\n                                    ${[...new Set(tasks.map(t => t.incharge))].filter(Boolean).map(u => `<option>${u}</option>`).join(\"\")}\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-sm btn-primary\" id=\"add-task-btn\">➕ Add Task</button>\n                        </div>\n\n                        <h4 style=\"margin-bottom:10px;\">Tasks List</h4>\n\n                        <table class=\"table table-bordered table-hover\">\n                            <thead>\n                                <tr>\n                                    <th onclick=\"sortBy('l2_task_name')\" style=\"cursor:pointer;\">Task ⬍</th>\n                                    <th onclick=\"sortBy('sector')\" style=\"cursor:pointer;\">Sector ⬍</th>\n                                    <th onclick=\"sortBy('incharge')\" style=\"cursor:pointer;\">In Charge ⬍</th>\n                                    <th onclick=\"sortBy('status')\" style=\"cursor:pointer;\">Status ⬍</th>\n                                    <th style=\"width:160px;\">Update</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                    `;\n\n                    taskList.forEach(task => {\n                        const can_update =\n                            current_user === \"Administrator\" ||\n                            (is_lead && task.sector === user_sector) ||\n                            (task.incharge === current_user);\n\n                        const badge_color =\n                            task.status === \"Completed\"   ? \"#28a745\" :\n                            task.status === \"In Progress\" ? \"#ffc107\" :\n                            task.status === \"Delayed\"     ? \"#dc3545\" : \"#0dcaf0\";\n\n                        html += `\n                            <tr>\n                                <td>${task.l2_task_name}</td>\n                                <td>${task.sector}</td>\n                                <td>\n                                    ${can_update ? `\n                                        <select class=\"form-control incharge-dropdown\"\n                                                data-task=\"${task.name}\"\n                                                data-sector=\"${task.sector}\"\n                                                style=\"padding:3px 6px; font-size:12px;\">\n                                            <option value=\"\">-- Select --</option>\n                                            ${(data.sector_users[task.sector] || [])\n                                                .map(u => `<option value=\"${u.user}\" ${task.incharge === u.user ? \"selected\" : \"\"}>${u.user}</option>`).join(\"\")}\n                                        </select>\n                                    ` : `\n                                        <span>${task.incharge || \"-\"}</span>\n                                    `}\n                                </td>\n                                <td>\n                                    <span class=\"badge\"\n                                        style=\"background:${badge_color}; color:white; padding:4px 8px; border-radius:4px;\">\n                                        ${task.status}\n                                    </span>\n                                </td>\n                                <td>\n                                    ${can_update ? `\n                                        <select class=\"form-control task-status-dropdown\"\n                                                data-task=\"${task.name}\"\n                                                style=\"padding:3px 6px; font-size:12px;\">\n                                            <option ${task.status === \"Pending\" ? \"selected\" : \"\"}>Pending</option>\n                                            <option ${task.status === \"In Progress\" ? \"selected\" : \"\"}>In Progress</option>\n                                            <option ${task.status === \"Completed\" ? \"selected\" : \"\"}>Completed</option>\n                                            <option ${task.status === \"Delayed\" ? \"selected\" : \"\"}>Delayed</option>\n                                        </select>\n                                    ` : `\n                                        <select class=\"form-control\" disabled style=\"padding:3px 6px;\">\n                                            <option selected>${task.status}</option>\n                                        </select>\n                                    `}\n                                </td>\n                            </tr>\n                        `;\n                    });\n\n                    html += `</tbody></table>`;\n                    frm.fields_dict.custom_tasks_overview.$wrapper.html(html);\n\n                    document.getElementById(\"add-task-btn\").onclick = () => open_add_task_modal(frm.doc.name);\n                    document.getElementById(\"flt-status\").onchange = e => { filter_status = e.target.value; applyFiltersAndRender(); };\n                    document.getElementById(\"flt-sector\").onchange = e => { filter_sector = e.target.value; applyFiltersAndRender(); };\n                    document.getElementById(\"flt-incharge\").onchange = e => { filter_incharge = e.target.value; applyFiltersAndRender(); };\n                    \n                    // In-Charge assignment handler\n                    setTimeout(() => {\n                        document.querySelectorAll(\".incharge-dropdown\").forEach(sel => {\n                            sel.addEventListener(\"change\", function () {\n                                let task = this.dataset.task;\n                                let user = this.value;\n                    \n                                frappe.call({\n                                    method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.update_task_incharge\",\n                                    args: { task_name: task, user },\n                                    callback() {\n                                        frappe.show_alert({\n                                            message: `Task assigned to ${user}`,\n                                            indicator: \"green\"\n                                        });\n                                        cur_frm.reload_doc();\n                                    }\n                                });\n                            });\n                        });\n                    }, 300);\n                    // Dropdown status update handler\n                    setTimeout(() => {\n                        document.querySelectorAll(\".task-status-dropdown\").forEach(sel => {\n                            sel.addEventListener(\"change\", function () {\n                                frappe.call({\n                                    method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.update_event_task_status\",\n                                    args: { l2_task_name: this.dataset.task, status: this.value },\n                                    callback() {\n                                        frappe.show_alert({ message: \"Task Updated\", indicator: \"green\" });\n                                        cur_frm.reload_doc();\n                                    }\n                                });\n                            });\n                        });\n                    }, 300);\n                }\n\n                applyFiltersAndRender();\n            }\n        });\n    }\n});\n\n//-------------------------------------------------------------\n// ADD NEW TASK MODAL\n//-------------------------------------------------------------\nwindow.open_add_task_modal = function(event_name) {\n    const d = new frappe.ui.Dialog({\n        title: \"Add Event Task\",\n        fields: [\n            { label:\"Task Name\", fieldname:\"l2_task_name\", fieldtype:\"Data\", reqd:1 },\n            { label:\"Sector\", fieldname:\"sector\", fieldtype:\"Link\", options:\"Sector\", reqd:1 },\n            { label:\"User In Charge\", fieldname:\"incharge\", fieldtype:\"Link\", options:\"User\" },\n            { label:\"Due Date\", fieldname:\"due_date\", fieldtype:\"Date\" },\n            { label:\"Description\", fieldname:\"task_description\", fieldtype:\"Small Text\" }\n        ],\n        primary_action_label: \"Create Task\",\n        primary_action(values) {\n            frappe.call({\n                method:\"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.create_event_task_from_popup\",\n                args:{ event:event_name, ...values },\n                callback() {\n                    frappe.show_alert({ message:\"Task Created\", indicator:\"green\" });\n                    d.hide(); cur_frm.reload_doc();\n                }\n            });\n        }\n    });\n    d.show();\n};",
  "view": "List"
 }
]