[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Event Readiness",
  "enabled": 1,
  "modified": "2025-12-03 12:09:34.572281",
  "module": null,
  "name": "Event UI Customization",
  "script": "//-------------------------------------------------------------\n// Load ApexCharts if not already loaded\n//-------------------------------------------------------------\nfunction load_apexcharts(callback) {\n    if (typeof ApexCharts !== \"undefined\") {\n        callback();\n        return;\n    }\n    const script = document.createElement(\"script\");\n    script.src = \"https://cdn.jsdelivr.net/npm/apexcharts@3.45.0\";\n    script.onload = callback;\n    document.head.appendChild(script);\n}\n\n//-------------------------------------------------------------\n// EVENT READINESS CLIENT SCRIPT\n//-------------------------------------------------------------\nfrappe.ui.form.on('Event Readiness', {\n    refresh(frm) {\n    // If new document: hide gauge + task UI\n    if (frm.is_new()) {\n        if (frm.fields_dict.custom_event_readiness_gauge)\n            frm.fields_dict.custom_event_readiness_gauge.$wrapper.empty();\n\n        if (frm.fields_dict.custom_tasks_overview)\n            frm.fields_dict.custom_tasks_overview.$wrapper.empty();\n\n        return; // stop execution here\n    }\n\n    // Existing document → render dashboard UI\n    load_apexcharts(() => frm.trigger(\"render_gauge\"));\n    frm.trigger(\"render_tasks\");\n},\n\n//-------------------------------------------------------------\n// GAUGE + TASK SUMMARY PANEL\n//-------------------------------------------------------------\nrender_gauge(frm) {\n\n    if (!frm.fields_dict.custom_event_readiness_gauge) return;\n\n    const readiness = frm.doc.event_readiness || 0;\n\n    // Colors for readiness levels\n    let gauge_color = '#dc3545'; // red\n    if (readiness >= 70) gauge_color = '#28a745'; // green\n    else if (readiness >= 40) gauge_color = '#ffc107'; // yellow\n\n    // Task Counts pulled from doctype fields\n    const total     = frm.doc.total_tasks || 0;\n    const pending   = frm.doc.pending_task || 0;\n    const progress  = frm.doc.in_progress_tasks || 0;\n    const completed = frm.doc.completed_task || 0;\n    const delayed   = frm.doc.delayed_tasks || 0;\n\n    frm.fields_dict.custom_event_readiness_gauge.$wrapper.html(`\n        <div style=\"display:flex; justify-content:center; align-items:center; gap:50px; margin-top:10px;\">\n\n            <!-- GAUGE LEFT -->\n            <div style=\"flex:1; text-align:center;\">\n                <h4>Event Readiness: ${readiness}%</h4>\n                <div id=\"event_readiness_gauge\" style=\"height:260px;\"></div>\n            </div>\n\n            <!-- TASK SUMMARY RIGHT -->\n            <div style=\"flex:1;\">\n                <h4 style=\"margin-bottom:10px;\">Task Summary</h4>\n\n                <div style=\"display:grid; grid-template-columns:repeat(2,1fr); gap:10px;\">\n\n                    <div class=\"stat-card\"><b>Total Tasks</b><br>${total}</div>\n                    <div class=\"stat-card\" style=\"color:#0dcaf0;\"><b>Pending</b><br>${pending}</div>\n                    <div class=\"stat-card\" style=\"color:#ffc107;\"><b>In Progress</b><br>${progress}</div>\n                    <div class=\"stat-card\" style=\"color:#28a745;\"><b>Completed</b><br>${completed}</div>\n                    <div class=\"stat-card\" style=\"color:#dc3545;\"><b>Delayed</b><br>${delayed}</div>\n\n                </div>\n            </div>\n        </div>\n    `);\n\n    // Apex radial gauge chart\n    const chart = new ApexCharts(document.querySelector(\"#event_readiness_gauge\"), {\n        series: [readiness],\n        chart: { type: 'radialBar', height: 260 },\n        colors: [gauge_color],\n        labels: ['Readiness'],\n        plotOptions: {\n            radialBar: {\n                hollow: { size: \"60%\" },\n                dataLabels: { value: { formatter: () => readiness + \"%\" } }\n            }\n        }\n    });\n\n    chart.render();\n},\n\n//-------------------------------------------------------------\n// TASK TABLE + ADD BUTTON + FILTERS + SORTING\n//-------------------------------------------------------------\nrender_tasks(frm) {\n    frappe.call({\n        method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.get_tasks_for_event\",\n        args: { event_name: frm.doc.name },\n        callback(r) {\n            const data = r.message || {};\n            let tasks = data.tasks || [];\n            const current_user = data.user;\n            const user_sector = data.user_sector;\n            const is_lead = data.is_lead === 1;\n\n            // FILTER STATE\n            let filter_status = \"\";\n            let filter_sector = \"\";\n            let filter_incharge = \"\";\n\n            // SORTING STATE\n            let sort_field = \"creation\";\n            let sort_order = \"asc\";\n\n            function applyFiltersAndRender() {\n                let filtered = tasks;\n\n                if (filter_sector)\n                    filtered = filtered.filter(t => t.sector === filter_sector);\n\n                if (filter_status)\n                    filtered = filtered.filter(t => t.status === filter_status);\n\n                if (filter_incharge)\n                    filtered = filtered.filter(t => t.incharge === filter_incharge);\n\n                filtered = filtered.sort((a, b) => {\n                    let va = a[sort_field] || \"\";\n                    let vb = b[sort_field] || \"\";\n\n                    if (va < vb) return sort_order === \"asc\" ? -1 : 1;\n                    if (va > vb) return sort_order === \"asc\" ? 1 : -1;\n                    return 0;\n                });\n\n                renderTable(filtered);\n            }\n\n            function toggleSort(field) {\n                sort_field = field;\n                sort_order = sort_order === \"asc\" ? \"desc\" : \"asc\";\n                applyFiltersAndRender();\n            }\n\n            function renderTable(taskList) {\n                let html = `\n                    <div style=\"display:flex; justify-content: space-between; margin-bottom: 12px;\">\n                        <div style=\"display:flex; gap:10px;\">\n                            <select class=\"form-control\" style=\"width:140px\" id=\"flt-status\">\n                                <option value=\"\">All Status</option>\n                                <option>Pending</option>\n                                <option>In Progress</option>\n                                <option>Completed</option>\n                                <option>Delayed</option>\n                            </select>\n\n                            <select class=\"form-control\" style=\"width:140px\" id=\"flt-sector\">\n                                <option value=\"\">All Sectors</option>\n                                ${[...new Set(tasks.map(t => t.sector))]\n                                    .map(sec => `<option>${sec}</option>`).join(\"\")}\n                            </select>\n\n                            <select class=\"form-control\" style=\"width:140px\" id=\"flt-incharge\">\n                                <option value=\"\">All Users</option>\n                                ${[...new Set(tasks.map(t => t.incharge))]\n                                    .filter(Boolean)\n                                    .map(u => `<option>${u}</option>`).join(\"\")}\n                            </select>\n                        </div>\n\n                        <button class=\"btn btn-sm btn-primary\" id=\"add-task-btn\">➕ Add Task</button>\n                    </div>\n\n                    <h4 style=\"margin: 10px 0;\">Tasks List</h4>\n\n                    <table class=\"table table-bordered table-hover\">\n                        <thead>\n                            <tr>\n                                <th onclick=\"sortBy('l2_task_name')\" style=\"cursor:pointer;\">Task ⬍</th>\n                                <th onclick=\"sortBy('sector')\" style=\"cursor:pointer;\">Sector ⬍</th>\n                                <th onclick=\"sortBy('incharge')\" style=\"cursor:pointer;\">In Charge ⬍</th>\n                                <th onclick=\"sortBy('status')\" style=\"cursor:pointer;\">Status ⬍</th>\n                                <th style=\"width:180px;\">Actions</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                `;\n\n                taskList.forEach(task => {\n                    const can_update =\n                        current_user === \"Administrator\" ||\n                        (is_lead && task.sector === user_sector) ||\n                        (task.incharge === current_user);\n\n                    html += `\n                        <tr>\n                            <td>${task.l2_task_name}</td>\n                            <td>${task.sector}</td>\n                            <td>${task.incharge || \"-\"}</td>\n                            <td><span class=\"badge\">${task.status}</span></td>\n                            <td>\n                                ${can_update ? `\n                                    <button class=\"btn btn-sm btn-primary\" onclick=\"update_task_status('${task.name}', 'In Progress')\">In Progress</button>\n                                    <button class=\"btn btn-sm btn-success\" onclick=\"update_task_status('${task.name}', 'Completed')\">Completed</button>\n                                    <button class=\"btn btn-sm btn-danger\" onclick=\"update_task_status('${task.name}', 'Delayed')\">Delayed</button>\n                                ` : `<span style=\"color:#888;\">No Access</span>`}\n                            </td>\n                        </tr>`;\n                });\n\n                html += `\n                        </tbody>\n                    </table>\n                `;\n\n                frm.fields_dict.custom_tasks_overview.$wrapper.html(html);\n\n                document.getElementById(\"add-task-btn\").onclick = () =>\n                    open_add_task_modal(frm.doc.name);\n\n                document.getElementById(\"flt-status\").onchange = e => {\n                    filter_status = e.target.value;\n                    applyFiltersAndRender();\n                };\n\n                document.getElementById(\"flt-sector\").onchange = e => {\n                    filter_sector = e.target.value;\n                    applyFiltersAndRender();\n                };\n\n                document.getElementById(\"flt-incharge\").onchange = e => {\n                    filter_incharge = e.target.value;\n                    applyFiltersAndRender();\n                };\n            }\n\n            // Global sort function\n            window.sortBy = toggleSort;\n\n            applyFiltersAndRender();\n        }\n    });\n}\n\n});\n\n//-------------------------------------------------------------\n// FUNCTIONS TO RENDER TABLE ROWS\n//-------------------------------------------------------------\nwindow.render_event_tasks = function(tasks) {\n    let rows = \"\";\n    tasks.forEach(t => {\n        rows += `\n            <tr>\n                <td>${t.l2_task_name}</td>\n                <td>${t.sector}</td>\n                <td>${t.user_in_charge || \"-\"}</td>\n                <td><span class=\"badge\">${t.status}</span></td>\n                <td>${t.due_date || \"-\"}</td>\n                <td>\n                    <button class=\"btn btn-sm btn-primary\" onclick=\"update_task_status('${t.name}', 'In Progress')\">In Progress</button>\n                    <button class=\"btn btn-sm btn-success\" onclick=\"update_task_status('${t.name}', 'Completed')\">Completed</button>\n                    <button class=\"btn btn-sm btn-danger\" onclick=\"update_task_status('${t.name}', 'Delayed')\">Delayed</button>\n                </td>\n            </tr>`;\n    });\n    document.querySelector(\"#event_tasks_table\").innerHTML = rows;\n};\n\n//-------------------------------------------------------------\n// PREPARE FILTER DROPDOWNS\n//-------------------------------------------------------------\nwindow.prepare_task_dropdowns = function(tasks) {\n    const s = document.getElementById(\"filter_sector\");\n    const u = document.getElementById(\"filter_user\");\n\n    [...new Set(tasks.map(t => t.sector).filter(Boolean))].forEach(x => s.innerHTML += `<option>${x}</option>`);\n    [...new Set(tasks.map(t => t.user_in_charge).filter(Boolean))].forEach(x => u.innerHTML += `<option>${x}</option>`);\n};\n\n//-------------------------------------------------------------\n// ATTACH FILTER/SORT HANDLERS\n//-------------------------------------------------------------\nwindow.attach_task_filters = function(original) {\n    const sector = document.getElementById(\"filter_sector\");\n    const status = document.getElementById(\"filter_status\");\n    const user   = document.getElementById(\"filter_user\");\n    const sort   = document.getElementById(\"filter_sort\");\n\n    function apply() {\n        let data = [...original];\n\n        if (sector.value) data = data.filter(d => d.sector === sector.value);\n        if (status.value) data = data.filter(d => d.status === status.value);\n        if (user.value)   data = data.filter(d => d.user_in_charge === user.value);\n        if (sort.value)   data.sort((a,b) => (a[sort.value] > b[sort.value]) ? 1 : -1);\n\n        window.render_event_tasks(data);\n    }\n\n    sector.onchange = status.onchange = user.onchange = sort.onchange = apply;\n};\n\n//-------------------------------------------------------------\n// TASK STATUS UPDATE CALL\n//-------------------------------------------------------------\nwindow.update_task_status = function(name, status) {\n    frappe.call({\n        method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.update_event_task_status\",\n        args: { l2_task_name: name, status },\n        callback() {\n            frappe.show_alert({ message:\"Task Updated\", indicator:\"green\" });\n            cur_frm.reload_doc();\n        }\n    });\n};\n\n//-------------------------------------------------------------\n// ADD NEW TASK MODAL POPUP\n//-------------------------------------------------------------\nwindow.open_add_task_modal = function(event_name) {\n\n    const d = new frappe.ui.Dialog({\n        title: \"Add Event Task\",\n        fields: [\n            { label:\"Task Name\", fieldname:\"l2_task_name\", fieldtype:\"Data\", reqd:1 },\n            { label:\"Sector\", fieldname:\"sector\", fieldtype:\"Link\", options:\"Sector\", reqd:1 },\n            { label:\"User In Charge\", fieldname:\"user_in_charge\", fieldtype:\"Link\", options:\"User\" },\n            { label:\"Due Date\", fieldname:\"due_date\", fieldtype:\"Date\" },\n            { label:\"Description\", fieldname:\"task_description\", fieldtype:\"Small Text\" }\n        ],\n        primary_action_label: \"Create Task\",\n        primary_action(values) {\n            frappe.call({\n                method:\"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.create_event_task_from_popup\",\n                args:{ event:event_name, ...values },\n                callback() {\n                    frappe.show_alert({ message:\"Task Created\", indicator:\"green\" });\n                    d.hide();\n                    cur_frm.reload_doc();\n                }\n            });\n        }\n    });\n    d.show();\n};",
  "view": "List"
 }
]