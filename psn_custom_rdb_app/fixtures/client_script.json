[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Event Readiness",
  "enabled": 1,
  "modified": "2025-12-08 13:04:35.431428",
  "module": null,
  "name": "Event UI Customization",
  "script": "//-------------------------------------------------------------\n// Load ApexCharts if not already loaded\n//-------------------------------------------------------------\nfunction load_apexcharts(callback) {\n    if (typeof ApexCharts !== \"undefined\") {\n        callback();\n        return;\n    }\n    const script = document.createElement(\"script\");\n    script.src = \"https://cdn.jsdelivr.net/npm/apexcharts@3.45.0\";\n    script.onload = callback;\n    document.head.appendChild(script);\n}\n\n//-------------------------------------------------------------\n// EVENT READINESS FORM SCRIPT\n//-------------------------------------------------------------\nfrappe.ui.form.on('Event Readiness', {\n    refresh(frm) {\n        if (frm.is_new()) {\n            frm.fields_dict.custom_event_readiness_gauge.$wrapper.empty();\n            frm.fields_dict.custom_tasks_overview.$wrapper.empty();\n            return;\n        }\n\n        load_apexcharts(() => frm.trigger(\"render_gauge\"));\n        frm.trigger(\"render_tasks\");\n    },\n\n    //---------------------------------------------------------\n    // READINESS GAUGE + COUNTDOWN + SUMMARY\n    //---------------------------------------------------------\n    render_gauge(frm) {\n        if (!frm.fields_dict.custom_event_readiness_gauge) return;\n\n        const readiness = frm.doc.event_readiness || 0;\n        let gauge_color = '#dc3545';\n        if (readiness >= 70) gauge_color = '#28a745';\n        else if (readiness >= 40) gauge_color = '#ffc107';\n\n        const total     = frm.doc.total_tasks || 0;\n        const pending   = frm.doc.pending_tasks || 0;\n        const progress  = frm.doc.in_progress_tasks || 0;\n        const completed = frm.doc.completed_tasks || 0;\n        const delayed   = frm.doc.delayed_tasks || 0;\n\n        frm.fields_dict.custom_event_readiness_gauge.$wrapper.html(`\n            <div style=\"display:flex; gap:40px; justify-content:center; margin-top:10px;\">\n\n                <!-- LEFT PANEL -->\n                <div style=\"flex:1; text-align:center;\">\n                    <h4 style=\"margin-bottom:10px;\">Event Readiness: ${readiness}%</h4>\n\n                    <!-- COUNTDOWN -->\n                    <div id=\"event-countdown\"\n                         style=\"margin-bottom:12px; font-size:16px; font-weight:bold; color:#444;\">\n                        Calculating...\n                    </div>\n\n                    <!-- GAUGE -->\n                    <div id=\"event_readiness_gauge\" style=\"height:260px;\"></div>\n                </div>\n\n                <!-- RIGHT PANEL -->\n                <div style=\"flex:1;\">\n                    <h4>Task Summary</h4>\n                    <div style=\"display:grid; grid-template-columns:repeat(2,1fr); gap:10px;\">\n                        <div class=\"stat-card\"><b>Total Tasks</b><br>${total}</div>\n                        <div class=\"stat-card\" style=\"color:#0dcaf0;\"><b>Pending</b><br>${pending}</div>\n                        <div class=\"stat-card\" style=\"color:#ffc107;\"><b>In Progress</b><br>${progress}</div>\n                        <div class=\"stat-card\" style=\"color:#28a745;\"><b>Completed</b><br>${completed}</div>\n                        <div class=\"stat-card\" style=\"color:#dc3545;\"><b>Delayed</b><br>${delayed}</div>\n                    </div>\n                </div>\n            </div>\n        `);\n\n        // RENDER GAUGE\n        new ApexCharts(document.querySelector(\"#event_readiness_gauge\"), {\n            series: [readiness],\n            chart: { type: 'radialBar', height: 260 },\n            colors: [gauge_color],\n            labels: ['Readiness'],\n            plotOptions: {\n                radialBar: {\n                    hollow: { size: \"60%\" },\n                    dataLabels: { value: { formatter: () => readiness + \"%\" } }\n                }\n            }\n        }).render();\n\n        //-----------------------------------------------------\n        // SIMPLE COUNTDOWN (AFTER WRAPPER EXISTS)\n        //-----------------------------------------------------\n        setTimeout(() => {\n            const eventDate = frm.doc.event_date;\n            const el = document.getElementById(\"event-countdown\");\n            if (!eventDate || !el) return;\n\n            function updateCountdown() {\n                const now = new Date();\n                const target = new Date(eventDate + \" 00:00:00\");\n                const diff = target - now;\n\n                if (diff <= 0) {\n                    el.innerHTML = `<span style=\"color:#28a745;font-weight:bold;\">üéâ Event Started</span>`;\n                    return;\n                }\n\n                const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n                const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);\n                const mins = Math.floor((diff / (1000 * 60)) % 60);\n                const secs = Math.floor((diff / 1000) % 60);\n\n                el.innerHTML = `‚è≥ <b>${days}</b>d | <b>${hours}</b>h | <b>${mins}</b>m | <b>${secs}</b>s left`;\n            }\n\n            updateCountdown();\n            setInterval(updateCountdown, 1000);\n        }, 900);\n    },\n\n    //---------------------------------------------------------\n    // TASKS TABLE WITH PERMISSION-BASED CONTROLS\n    //---------------------------------------------------------\n    render_tasks(frm) {\n        frappe.call({\n            method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.get_tasks_for_event\",\n            args: { event_name: frm.doc.name },\n            callback(r) {\n                const data = r.message;\n                const tasks = data.tasks || [];\n                const current_user = data.user;\n                const user_sector = data.user_sector;\n                const is_lead = data.is_lead === 1;\n\n                let filter_status = \"\", filter_sector = \"\", filter_incharge = \"\", sort_field = \"creation\", sort_order = \"asc\";\n\n                function applyFiltersAndRender() {\n                    let result = tasks;\n                    if (filter_sector)   result = result.filter(t => t.sector === filter_sector);\n                    if (filter_status)   result = result.filter(t => t.status === filter_status);\n                    if (filter_incharge) result = result.filter(t => t.incharge === filter_incharge);\n\n                    result.sort((a, b) => (a[sort_field] < b[sort_field] ? -1 : 1) * (sort_order === \"asc\" ? 1 : -1));\n                    renderTable(result);\n                }\n\n                window.sortBy = field => {\n                    sort_field = field;\n                    sort_order = sort_order === \"asc\" ? \"desc\" : \"asc\";\n                    applyFiltersAndRender();\n                };\n\n                function renderTable(list) {\n                    let html = `\n                        <div style=\"display:flex; justify-content:space-between; margin-bottom:12px;\">\n                            <div style=\"display:flex; gap:10px;\">\n                                <select id=\"flt-status\" class=\"form-control\" style=\"width:140px\">\n                                    <option value=\"\">All Status</option>\n                                    <option>Pending</option>\n                                    <option>In Progress</option>\n                                    <option>Completed</option>\n                                    <option>Delayed</option>\n                                </select>\n\n                                <select id=\"flt-sector\" class=\"form-control\" style=\"width:140px\">\n                                    <option value=\"\">All Sectors</option>\n                                    ${[...new Set(tasks.map(t => t.sector))].map(sec => `<option>${sec}</option>`).join(\"\")}\n                                </select>\n\n                                <select id=\"flt-incharge\" class=\"form-control\" style=\"width:140px\">\n                                    <option value=\"\">All Users</option>\n                                    ${[...new Set(tasks.map(t => t.incharge))].filter(Boolean).map(u => `<option>${u}</option>`).join(\"\")}\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-sm btn-primary\" id=\"add-task-btn\">‚ûï Add Task</button>\n                        </div>\n                        <h4 style=\"margin-bottom:10px;\">Tasks List</h4>\n\n                        <table class=\"table table-bordered table-hover\">\n                            <thead>\n                                <tr>\n                                    <th onclick=\"sortBy('l2_task_name')\" style=\"cursor:pointer;\">Task ‚¨ç</th>\n                                    <th onclick=\"sortBy('sector')\" style=\"cursor:pointer;\">Sector ‚¨ç</th>\n                                    <th onclick=\"sortBy('incharge')\" style=\"cursor:pointer;\">In Charge ‚¨ç</th>\n                                    <th onclick=\"sortBy('status')\" style=\"cursor:pointer;\">Status ‚¨ç</th>\n                                    <th style=\"width:160px;\">Update</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                    `;\n\n                    list.forEach(task => {\n                        const can_update =\n                            current_user === \"Administrator\" ||\n                            (is_lead && task.sector === user_sector) ||\n                            (task.incharge === current_user);\n\n                        const badge_color =\n                            task.status === \"Completed\" ? \"#28a745\" :\n                            task.status === \"In Progress\" ? \"#ffc107\" :\n                            task.status === \"Delayed\" ? \"#dc3545\" : \"#0dcaf0\";\n\n                        html += `\n                            <tr>\n                                <td class=\"task-link\" data-task=\"${task.name}\" style=\"cursor:pointer;color:#0a66c2;\">\n                                    ${task.l2_task_name}\n                                </td>\n                                <td>${task.sector}</td>\n\n                                ${(is_lead || current_user === \"Administrator\")\n                                    ? `<td>\n                                            <select class=\"form-control incharge-dropdown\"\n                                                    data-task=\"${task.name}\">\n                                                <option value=\"\">-- Select --</option>\n                                                ${(data.sector_users[task.sector] || [])\n                                                    .map(u => `<option value=\"${u.user}\" ${task.incharge === u.user ? \"selected\" : \"\"}>${u.user}</option>`)\n                                                    .join(\"\")}\n                                            </select>\n                                      </td>`\n                                    : `<td><span>${task.incharge || \"-\"}</span></td>`\n                                }\n\n                                <td>\n                                    <span class=\"badge\"\n                                        style=\"background:${badge_color}; color:white;\">\n                                        ${task.status}\n                                    </span>\n                                </td>\n\n                                <td>\n                                    ${can_update\n                                        ? `\n                                            <select class=\"form-control task-status-dropdown\"\n                                                    data-task=\"${task.name}\">\n                                                <option ${task.status === \"Pending\" ? \"selected\" : \"\"}>Pending</option>\n                                                <option ${task.status === \"In Progress\" ? \"selected\" : \"\"}>In Progress</option>\n                                                <option ${task.status === \"Completed\" ? \"selected\" : \"\"}>Completed</option>\n                                                <option ${task.status === \"Delayed\" ? \"selected\" : \"\"}>Delayed</option>\n                                            </select>\n                                          `\n                                        : `<select class=\"form-control\" disabled><option>${task.status}</option></select>`\n                                    }\n                                </td>\n                            </tr>\n                        `;\n                    });\n\n                    html += `</tbody></table>`;\n                    frm.fields_dict.custom_tasks_overview.$wrapper.html(html);\n\n                    document.getElementById(\"add-task-btn\").onclick = () => open_add_task_modal(frm.doc.name);\n                    document.getElementById(\"flt-status\").onchange = e => { filter_status = e.target.value; applyFiltersAndRender(); };\n                    document.getElementById(\"flt-sector\").onchange = e => { filter_sector = e.target.value; applyFiltersAndRender(); };\n                    document.getElementById(\"flt-incharge\").onchange = e => { filter_incharge = e.target.value; applyFiltersAndRender(); };\n\n                    // IN-CHARGE UPDATE\n                    setTimeout(() => {\n                        document.querySelectorAll(\".incharge-dropdown\").forEach(sel => {\n                            sel.addEventListener(\"change\", function () {\n                                frappe.call({\n                                    method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.update_task_incharge\",\n                                    args: { task_name: this.dataset.task, user: this.value },\n                                    callback() { cur_frm.reload_doc(); }\n                                });\n                            });\n                        });\n                    }, 200);\n                    \n                    setTimeout(() => {\n                        document.querySelectorAll(\".task-link\").forEach(el => {\n                            el.addEventListener(\"click\", function () {\n                                open_task_detail_modal(this.dataset.task);\n                            });\n                        });\n                    }, 200);\n\n                    // STATUS UPDATE (with delay reason popup)\nsetTimeout(() => {\n    document.querySelectorAll(\".task-status-dropdown\").forEach(sel => {\n        sel.addEventListener(\"change\", function () {\n            const task_name  = this.dataset.task;\n            const new_status = this.value;\n\n            // helper to actually call the server\n            const update_status = (delay_reason) => {\n                frappe.call({\n                    method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.update_event_task_status\",\n                    args: {\n                        l2_task_name: task_name,\n                        status: new_status,\n                        delay_reason: delay_reason || \"\"\n                    },\n                    callback() {\n                        cur_frm.reload_doc();\n                    }\n                });\n            };\n\n            // if delayed ‚Üí ask for reason first\n            if (new_status === \"Delayed\") {\n                const d = new frappe.ui.Dialog({\n                    title: \"Reason for Delay\",\n                    fields: [\n                        {\n                            label: \"Delay Reason\",\n                            fieldname: \"delay_reason\",\n                            fieldtype: \"Small Text\",\n                            reqd: 1\n                        }\n                    ],\n                    primary_action_label: \"Submit\",\n                    primary_action(values) {\n                        d.hide();\n                        update_status(values.delay_reason);\n                    }\n                });\n                d.show();\n            } else {\n                // all other statuses, just update\n                update_status();\n            }\n        });\n    });\n}, 200);\n                }\n\n                applyFiltersAndRender();\n            }\n        });\n    }\n});\n\n//-------------------------------------------------------------\n// ADD TASK MODAL\n//-------------------------------------------------------------\nwindow.open_add_task_modal = function(event_name) {\n    const d = new frappe.ui.Dialog({\n        title: \"Add Event Task\",\n        fields: [\n            { label: \"Task Name\", fieldname: \"l2_task_name\", fieldtype: \"Data\", reqd: 1 },\n            { label: \"Sector\", fieldname: \"sector\", fieldtype: \"Link\", options: \"Sector\", reqd: 1 },\n            { label: \"User In Charge\", fieldname: \"incharge\", fieldtype: \"Link\", options: \"User\" },\n            { label: \"Due Date\", fieldname: \"due_date\", fieldtype: \"Date\" },\n            { label: \"Description\", fieldname: \"task_description\", fieldtype: \"Small Text\" }\n        ],\n        primary_action_label: \"Create Task\",\n        primary_action(values) {\n            frappe.call({\n                method:\"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.create_event_task_from_popup\",\n                args:{ event:event_name, ...values },\n                callback() {\n                    frappe.show_alert({ message:\"Task Created\", indicator:\"green\" });\n                    d.hide(); cur_frm.reload_doc();\n                }\n            });\n        }\n    });\n    d.show();\n};\n\nfunction render_activity_log(task_name, dialog) {\n    frappe.call({\n        method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.get_task_activity\",\n        args: { task_name },\n        callback(r) {\n            const logs = r.message || [];\n            let html = \"\";\n\n            if (!logs.length) {\n                html = `<p style=\"color:#666; font-style:italic;\">No activity recorded yet.</p>`;\n            } else {\n                html = `\n                    <div class=\"accordion\" id=\"taskHistory\">\n                        ${logs.map((log, i) => `\n                            <div class=\"accordion-item\">\n                                <h2 class=\"accordion-header\">\n                                    <button class=\"accordion-button collapsed\"\n                                        type=\"button\" data-bs-toggle=\"collapse\"\n                                        data-bs-target=\"#collapse${i}\">\n                                        ${log.modified_by} ‚Äî \n                                        ${frappe.format(log.creation, \"Datetime\")}\n                                    </button>\n                                </h2>\n                                <div id=\"collapse${i}\" class=\"accordion-collapse collapse\"\n                                    data-bs-parent=\"#taskHistory\">\n                                    <div class=\"accordion-body\">\n                                        ${log.content || \"No Details\"}\n                                    </div>\n                                </div>\n                            </div>\n                        `).join(\"\")}\n                    </div>`;\n            }\n\n            dialog.fields_dict.activity_log_html.$wrapper.html(html);\n        }\n    });\n}\n\nwindow.open_task_detail_modal = function(task_name) {\n    frappe.call({\n        method: \"frappe.client.get\",\n        args: { doctype: \"Event Task\", name: task_name },\n        callback(r) {\n            const task = r.message;\n\n            const d = new frappe.ui.Dialog({\n                title: `Task Details ‚Äî ${task.l2_task_name}`,\n                size: \"extra-large\",\n                fields: [\n                    { fieldtype: \"Data\", label: \"Task Name\", fieldname: \"l2_task_name\", default: task.l2_task_name, read_only: 1 },\n                    { fieldtype: \"Link\", label: \"Sector\", fieldname: \"sector\", options: \"Sector\", default: task.sector, read_only: 1 },\n                    { fieldtype: \"Link\", label: \"In Charge\", fieldname: \"incharge\", options: \"User\", default: task.incharge, read_only: 1 },\n                    { fieldtype: \"Small Text\", label: \"Description\", fieldname: \"task_description\", default: task.task_description, read_only: 1 },\n                    { fieldtype: \"Select\", label: \"Status\", fieldname: \"status\", options: \"Pending\\nIn Progress\\nCompleted\\nDelayed\", default: task.status },\n                    { fieldtype: \"Small Text\", label: \"Delay Reason\", fieldname: \"delay_reason\", default: task.delay_reason, read_only: 1 },\n\n                    { fieldtype: \"Section Break\", label: \"Activity History\" },\n                    { fieldtype: \"HTML\", fieldname: \"activity_log_html\" },\n                ],\n                primary_action_label: \"Update Status\",\n                primary_action(values) {\n                    const delay_reason =\n                        values.status === \"Delayed\"\n                        ? prompt(\"Please enter delay reason:\")\n                        : null;\n\n                    frappe.call({\n                        method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.update_event_task_status\",\n                        args: {\n                            l2_task_name: task_name,\n                            status: values.status,\n                            delay_reason\n                        },\n                        callback() {\n                            frappe.show_alert({ message:\"Task Updated\", indicator:\"green\" });\n                            d.hide();\n                            cur_frm.reload_doc();\n                        }\n                    });\n                }\n            });\n\n            render_activity_log(task_name, d);\n            d.show();\n        }\n    });\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Workspace",
  "enabled": 1,
  "modified": "2025-12-03 18:21:52.873323",
  "module": "PSN Readiness Dashboard",
  "name": "Event Readiness Dashboard Script",
  "script": "// ---- CREATE SECTOR ----\nwindow.create_sector = function () {\n    frappe.new_doc(\"Sector\");\n};\n\n// ---- ADD SECTOR MEMBERS ----\nwindow.add_sector_members = function () {\n    let d = new frappe.ui.Dialog({\n        title: \"Add Members to Sector\",\n        fields: [\n            {\n                label: \"Sector\",\n                fieldname: \"sector\",\n                fieldtype: \"Link\",\n                options: \"Sector\",\n                reqd: 1\n            },\n            {\n                label: \"Members\",\n                fieldname: \"members\",\n                fieldtype: \"Table\",\n                cannot_add_rows: false,\n                in_place_edit: true,\n                fields: [\n                    {\n                        label: \"User\",\n                        fieldname: \"user\",\n                        fieldtype: \"Link\",\n                        options: \"User\",\n                        reqd: 1\n                    },\n                    {\n                        label: \"Is Sector Lead?\",\n                        fieldname: \"is_sector_lead\",\n                        fieldtype: \"Check\"\n                    }\n                ]\n            }\n        ],\n        primary_action_label: \"Save Members\",\n        primary_action(values) {\n            frappe.call({\n                method: \"psn_custom_rdb_app.psn_readiness_dashboard.event_logic.add_sector_members\",\n                args: values,\n                callback: function () {\n                    frappe.show_alert({ message: \"Sector Members Updated\", indicator: \"green\" });\n                    d.hide();\n                }\n            });\n        }\n    });\n    d.show();\n};\n\n// ---- CREATE EVENT READINESS ----\nwindow.create_event_readiness = function () {\n    frappe.new_doc(\"Event Readiness\");\n};",
  "view": "Form"
 }
]